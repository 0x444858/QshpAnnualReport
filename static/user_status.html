<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>报告状态</title>
    <link rel="stylesheet" href="/AnnualReport/static/style.css">
    <link rel="stylesheet" href="/AnnualReport/static/mobile.css" media="(max-width: 599px)">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
</head>
<body>
<div id="root" style="background-color: #71abff">
    <div id="logo_div">
        <img src="/AnnualReport/static/qshp-logo-outlined.png" style="margin: 40px auto" alt="logo">
    </div>
    <div id="main_div">
        <h1>您所查询的UID</h1>
        <h2 id="uid" style="color:gray">0</h2>
        <h1>当前状态</h1>
        <h2 id="status">未知</h2>
        <h3 id="status_additional"></h3>
        <div  id="goto_report_div" style="display:none">
            <button class="button_common" onclick="goto_report()">前往报告</button>
        </div>
    </div>
    <div id="apply_div" style="display:none">
        <strong>因为服务器不在中国大陆，存在 GFW 的网络干扰，爬虫很有可能遇到网络错误，导致整个任务完全或部分失败</strong>
        <br>
        <br>
        <strong>表现为报告完全无法生成或某段时间的数据缺失</strong>
        <br>
        <br>
        <strong>为保证效果，采用手动申请的人工监视的方式</strong>
        <br>
        <br>
        <strong>因此，自助申请通道已关闭，<span style="color:#9E0000">请手动回复
            <a href="https://bbs.uestc.edu.cn/thread/2419203">申请帖</a>，等待楼主手动处理。</span></strong>
    </div>
</div>
<script>
    function goto_report() {
        const urlParams = new URLSearchParams(window.location.search);
        const uid = urlParams.get('uid');
        window.location.href = `/AnnualReport/report/?uid=${uid}`;
    }
    function formatSize(bytes) {
        if (bytes === 0) return '0 KB';
        const kb = bytes / 1024;
        return kb.toFixed(1) + ' KB';
    }
    // 获取 URL 参数中的 uid
    function getUidFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get('uid');
    }
    // 设置状态显示样式
    function setStatus(statusText, color, additionalText = '') {
        const statusEl = document.getElementById('status');
        const additionalEl = document.getElementById('status_additional');
        statusEl.textContent = statusText;
        statusEl.style.color = color;
        additionalEl.textContent = additionalText;
        additionalEl.style.display = additionalText ? 'block' : 'none';
    }
    // 显示/隐藏元素
    function toggleElement(elementId, show) {
        const el = document.getElementById(elementId);
        if (el) {
            el.style.display = show ? 'block' : 'none';
        }
    }
    async function checkUserStatus() {
        const uidParam = getUidFromUrl();
        const uidEl = document.getElementById('uid');
        uidEl.textContent = uidParam || '0';
        // 检查 UID
        if (!uidParam) {
            setStatus('缺少 uid 参数', 'red');
            toggleElement('apply_div', true);
            toggleElement('goto_report_div', false);
            return;
        }
        let uidInt;
        try {
            uidInt = parseInt(uidParam, 10);
            if (isNaN(uidInt) || uidInt <= 0 || String(uidInt) !== uidParam) {
                throw new Error('Invalid UID');
            }
        } catch (e) {
            setStatus('uid 必须为正整数', 'red');
            toggleElement('apply_div', true);
            toggleElement('goto_report_div', false);
            return;
        }
        document.title = `${uidInt} - 报告状态`;
        // 调用 API
        try {
            const response = await fetch(`/AnnualReport/api/user_status?uid=${encodeURIComponent(uidParam)}`);
            if (!response.ok) {
                let errorMsg = `HTTP ${response.status}`;
                try {
                    const errorData = await response.json();
                    errorMsg = errorData.message || errorMsg;
                } catch (e) {
                    // 无法解析 JSON，保留 HTTP 状态
                }
                setStatus(`API 错误: ${errorMsg}`, 'red');
                toggleElement('apply_div', true);
                toggleElement('goto_report_div', false);
                return;
            }
            const data = await response.json();
            // 根据状态处理
            switch (data.status) {
                case '完成':
                    setStatus('年度报告已生成完成', 'green');
                    toggleElement('apply_div', false);
                    toggleElement('goto_report_div', true);
                    break;
    
                case '未生成':
                    setStatus('用户年度报告尚未生成', 'red');
                    toggleElement('apply_div', true);
                    toggleElement('goto_report_div', false);
                    break;
    
                case '正在获取数据':
                    const sizeText = data.size !== undefined ? formatSize(data.size) : '未知';
                    setStatus('正在获取用户数据，请稍后刷新', 'orange');
                    // setStatus('正在获取用户数据，请稍后', 'orange', `已获取数据量：${sizeText}`);
                    toggleElement('apply_div', false);
                    toggleElement('goto_report_div', false);
                    break;
    
                case '队列':
                    const rankText = data.queue ? `当前排第 ${data.queue} 位` : '已在队列中';
                    setStatus('用户已在生成队列中，请稍后刷新', 'orange');
                    setStatus('用户已在生成队列中，请稍后刷新', 'orange', rankText);
                    toggleElement('apply_div', false);
                    toggleElement('goto_report_div', false);
                    break;
    
                case '错误':
                default:
                    setStatus(data.message || '未知错误', 'red');
                    toggleElement('apply_div', true);
                    toggleElement('goto_report_div', false);
                    break;
            }
        } catch (error) {
            console.error('Fetch error:', error);
            setStatus(`网络错误: ${error.message || '无法连接到服务器'}`, 'red');
            toggleElement('apply_div', true);
            toggleElement('goto_report_div', false);
        }
    }
    document.addEventListener('DOMContentLoaded', checkUserStatus);
</script>
</body>
</html>
